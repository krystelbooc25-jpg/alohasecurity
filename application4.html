<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Job Application - Review & Submit</title>
    <link rel="stylesheet" href="application.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        :root { --primary-red: #D2042D; --container-bg: #ffffff; --text-main: #1a1a1a; --border-color: #d1d9e0; --input-bg: #ffffff; }
        body { padding: 20px 10px; display: flex; justify-content: center; align-items: flex-start; min-height: 100vh; background-color: #f0f4f8; color: var(--text-main); font-family: 'Segoe UI', sans-serif; }
        
        .application-container { width: 100%; max-width: 1000px; background-color: var(--container-bg); border-radius: 12px; box-shadow: 0 10px 30px rgba(0,0,0,0.1); border-top: 5px solid var(--primary-red); overflow: hidden; }
        .summary-grid { display: grid; grid-template-columns: auto 1fr auto 1fr; gap: 10px 20px; }
        .summary-grid p { word-break: break-word; margin: 0; }
        .id-select { width: 100%; margin-bottom: 10px; padding: 10px; border-radius: 6px; border: 1px solid var(--border-color); background-color: var(--input-bg); color: var(--text-main); font-size: 14px; }

        /* --- CUSTOM MODAL CSS --- */
        .modal-overlay {
            display: none;
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0, 0, 0, 0.7);
            backdrop-filter: blur(4px);
            z-index: 9999;
            justify-content: center;
            align-items: center;
        }

        .modal-box {
            background: white;
            width: 90%;
            max-width: 400px;
            padding: 30px;
            border-radius: 20px;
            text-align: center;
            box-shadow: 0 20px 40px rgba(0,0,0,0.3);
            border-top: 6px solid var(--primary-red);
            transform: scale(0.8);
            opacity: 0;
            transition: 0.3s ease-out;
        }

        .modal-overlay.active { display: flex; }
        .modal-overlay.active .modal-box { transform: scale(1); opacity: 1; }

        .modal-icon {
            font-size: 50px;
            color: var(--primary-red);
            margin-bottom: 15px;
        }

        /* Success Green Color */
        .modal-icon.success-icon { color: #28a745; }

        .modal-box h2 {
            margin: 0 0 10px;
            color: #333;
            font-size: 22px;
        }

        .modal-box p {
            color: #666;
            line-height: 1.5;
            margin-bottom: 25px;
        }

        .modal-btn {
            background: var(--primary-red);
            color: white;
            border: none;
            padding: 12px 30px;
            border-radius: 10px;
            font-weight: bold;
            cursor: pointer;
            font-size: 16px;
            transition: 0.2s;
            width: 100%;
        }

        .modal-btn:hover { background: #a50323; transform: translateY(-2px); }

        @media (max-width: 768px) { .app-header { flex-direction: column; text-align: center; } .summary-grid { grid-template-columns: 1fr; } .form-footer { flex-direction: column-reverse; gap: 10px; } .btn { width: 100%; justify-content: center; } }
    </style>
</head>
<body>

    <!-- CUSTOM MODAL HTML -->
    <div id="duplicate-modal" class="modal-overlay">
        <div class="modal-box">
            <div id="modal-icon-div" class="modal-icon"><i class="fas fa-exclamation-circle"></i></div>
            <h2 id="modal-title">Notification</h2>
            <p id="modal-msg">Processing request...</p>
            <button class="modal-btn" onclick="closeModal()">OK</button>
        </div>
    </div>

    <div class="application-container">
        <header class="app-header" style="display:flex; justify-content:space-between; align-items:center; padding:20px;">
            <a href="application3.html" class="back-link" style="text-decoration:none; color:inherit;"><i class="fas fa-arrow-left"></i> Back</a>
            <div class="logo"><h2>Job Application</h2></div>
            <div class="step-counter">Step 4 of 4</div>
        </header>

        <main class="form-container" style="padding:30px;">
            <form id="final-form">
                <div class="application-summary" style="background: rgba(210,4,45,0.05); padding:20px; border-radius:12px; border:1px solid var(--primary-red); margin-bottom:25px;">
                    <h4 style="color:var(--primary-red); margin-bottom:15px;">Review Details</h4>
                    <div class="summary-grid">
                        <p><strong>Name:</strong></p><p id="summary-name">Loading...</p>
                        <p><strong>Email:</strong></p><p id="summary-email">Loading...</p>
                        <p><strong>Position:</strong></p><p id="summary-position">Loading...</p>
                    </div>
                </div>

                <div class="form-group">
                    <label>Upload Supporting Documents *</label>
                    <div style="display:flex; gap:15px; margin-top:10px;">
                        <div style="flex:1; border:2px dashed var(--border-color); padding:20px; text-align:center; border-radius:10px;">
                            <span>Resume/CV *</span>
                            <input type="file" id="resume-cv" required style="margin-top:10px;">
                        </div>
                        <div style="flex:1; border:2px dashed var(--border-color); padding:20px; text-align:center; border-radius:10px;">
                            <select id="id-type" class="id-select" required>
                                <option value="">Select ID Type *</option>
                                <option value="Driver's License">Driver's License</option>
                                <option value="Passport">Passport</option>
                                <option value="National ID">National ID</option>
                            </select>
                            <input type="file" id="valid-id" required>
                        </div>
                    </div>
                </div>

                <div style="margin-top:20px;">
                    <label style="cursor:pointer;"><input type="checkbox" id="consent-truth" required> I certify that all information provided is true and correct.</label>
                </div>

                <footer class="form-footer" style="display:flex; justify-content:space-between; margin-top:30px; border-top:1px solid #eee; padding-top:20px;">
                    <a href="application3.html" class="btn btn-secondary" style="text-decoration:none; padding:12px 25px; border:1px solid #ddd; border-radius:8px;">Back</a>
                    <button type="submit" id="submit-button" class="btn btn-success" style="background:var(--primary-red); color:white; border:none; padding:12px 30px; border-radius:8px; font-weight:bold; cursor:pointer;">Submit Application</button>
                </footer>
            </form>
        </main>
    </div>

   <script>
    const supabaseUrl = 'https://kkaelwhdcsgaodbhrxqt.supabase.co';
    const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImtrYWVsd2hkY3NnYW9kYmhyeHF0Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTYxOTA4NzksImV4cCI6MjA3MTc2Njg3OX0.wSFv1AZgZDXjGHiIwOHyWzqTDk0v6NbR4-2r90iF9ok';
    const _supabase = supabase.createClient(supabaseUrl, supabaseKey);

    const applicationData = JSON.parse(localStorage.getItem('applicationData')) || {};
    
    document.getElementById('summary-name').innerText = `${applicationData.first_name || ''} ${applicationData.last_name || ''}`;
    document.getElementById('summary-email').innerText = applicationData.email || 'N/A';
    document.getElementById('summary-position').innerText = applicationData.desired_position || 'N/A';

    function showModal(title, msg, iconClass = "fa-exclamation-circle") {
        document.getElementById('modal-title').innerText = title;
        document.getElementById('modal-msg').innerText = msg;
        const iconDiv = document.getElementById('modal-icon-div');
        iconDiv.innerHTML = `<i class="fas ${iconClass}"></i>`;
        if (title === "Success") { iconDiv.classList.add('success-icon'); } 
        else { iconDiv.classList.remove('success-icon'); }
        document.getElementById('duplicate-modal').classList.add('active');
    }

    function closeModal() {
        const title = document.getElementById('modal-title').innerText;
        document.getElementById('duplicate-modal').classList.remove('active');
        if (title === "Success") { window.location.href = 'index.html'; }
    }

    document.getElementById('final-form').onsubmit = async (e) => {
        e.preventDefault();
        const btn = document.getElementById('submit-button');
        const idType = document.getElementById('id-type').value;

        btn.disabled = true;
        btn.innerText = "Processing...";

        try {
            // 1. AGE CHECK
            const birthDate = new Date(applicationData.dob);
            const today = new Date();
            let age = today.getFullYear() - birthDate.getFullYear();
            if (today.getMonth() < birthDate.getMonth() || (today.getMonth() === birthDate.getMonth() && today.getDate() < birthDate.getDate())) {
                age--;
            }
            if (age < 21) {
                btn.disabled = false;
                btn.innerText = "Submit Application";
                showModal("Age Requirement", "You must be at least 21 years old to apply.", "fa-user-clock");
                return;
            }

            // 2. DUPLICATE CHECK
            const { data: dup, error: nameErr } = await _supabase
                .from('applicants')
                .select('id')
                .ilike('first_name', applicationData.first_name.trim())
                .ilike('last_name', applicationData.last_name.trim())
                .eq('dob', applicationData.dob)
                .ilike('email', applicationData.email.trim())
                .limit(1);

            if (nameErr) throw nameErr;

            if (dup && dup.length > 0) {
                btn.disabled = false;
                btn.innerText = "Submit Application";
                showModal("Record Exists", "Our records show that you have already submitted an application. Multiple submissions are not allowed."); 
                return;
            }

            // 3. UPLOADING
            btn.innerText = "Uploading Files...";
            const resumeFile = document.getElementById('resume-cv').files[0];
            const idFile = document.getElementById('valid-id').files[0];
            const ts = Date.now();

            const { error: rErr } = await _supabase.storage.from('applicant-files').upload(`resumes/${ts}-${resumeFile.name}`, resumeFile);
            if (rErr) throw rErr;
            applicationData.resume_url = _supabase.storage.from('applicant-files').getPublicUrl(`resumes/${ts}-${resumeFile.name}`).data.publicUrl;

            const { error: iErr } = await _supabase.storage.from('applicant-files').upload(`ids/${ts}-${idFile.name}`, idFile);
            if (iErr) throw iErr;
            applicationData.valid_id_url = _supabase.storage.from('applicant-files').getPublicUrl(`ids/${ts}-${idFile.name}`).data.publicUrl;

            // 4. SAVE
            btn.innerText = "Saving Data...";
            applicationData.status = 'Pending';
            applicationData.id_type = idType;
            
            const { error: insertErr } = await _supabase.from('applicants').insert([applicationData]);
            if (insertErr) throw insertErr;

            // --- TRIGGER EMAIL NOTIFICATION ---
            console.log("Triggering email...");
            try {
                await _supabase.functions.invoke('send-email', {
                    body: {
                        applicant_name: applicationData.first_name,
                        applicant_email: applicationData.email,
                        position: applicationData.desired_position
                    }
                });
                console.log("Email triggered successfully");
            } catch (emailErr) {
                console.error("Email failed but data saved:", emailErr);
            }

            localStorage.removeItem('applicationData');
            showModal("Success", "Application Submitted Successfully! Please wait for our HR team to contact you.", "fa-check-circle");

        } catch (error) {
            btn.disabled = false;
            btn.innerText = "Submit Application";
            console.error(error);
            showModal("Error", "Error: " + error.message, "fa-times-circle");
        }
    };
   </script>
</body>
</html>
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Job Application - Review & Submit</title>
    <link rel="stylesheet" href="application.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        /* --- GLOBAL RESPONSIVE FIXES --- */
        * { box-sizing: border-box; }
        
        body {
            padding: 20px 10px;
            display: flex;
            justify-content: center;
            align-items: flex-start; /* Better for long forms on mobile */
            min-height: 100vh;
        }

        .application-container {
            width: 100%;
            max-width: 1000px;
        }

        /* Responsive Summary Grid */
        .summary-grid {
            display: grid;
            grid-template-columns: auto 1fr auto 1fr;
            gap: 10px 20px;
        }

        .summary-grid p {
            word-break: break-word; /* Prevents long emails from breaking layout */
            margin: 0;
        }

        /* --- MOBILE BREAKPOINT (Tablets and Phones) --- */
        @media (max-width: 768px) {
            .app-header {
                flex-direction: column;
                text-align: center;
                gap: 15px;
            }

            .progress-bar {
                padding: 20px 10px;
            }

            .step-label {
                display: none; /* Hide text labels on mobile to save space */
            }

            .connector {
                margin: 0 5px; /* Shrink the lines between circles */
            }

            .form-container {
                padding: 20px 15px;
            }

            .file-upload-container {
                flex-direction: column; /* Stack upload boxes vertically */
                gap: 15px;
            }

            .summary-grid {
                grid-template-columns: 1fr; /* Single column summary */
                gap: 5px;
            }

            .summary-grid p strong {
                display: block;
                margin-top: 10px;
                color: #002b5c;
            }

            .form-footer {
                flex-direction: column-reverse; /* Stack buttons: Submit on top */
                gap: 12px;
            }

            .btn {
                width: 100%;
                justify-content: center;
                padding: 15px;
            }
        }
    </style>
</head>
<body>
    <div class="application-container">
        <header class="app-header">
            <a href="application3.html" class="back-link"><i class="fas fa-arrow-left"></i> Back</a>
            <div class="logo">
                <img src="Resources/logo.jpg" alt="Logo" style="height: 50px;">
                <div class="logo-text">
                    <h2>Job Application</h2>
                    <p>Aloha Security Agency</p>
                </div>
            </div>
            <div class="step-counter">Step 4 of 4</div>
        </header>

        <nav class="progress-bar">
            <div class="step complete"><div class="step-number"><i class="fas fa-check"></i></div><div class="step-label">Personal Info</div></div>
            <div class="connector active"></div>
            <div class="step complete"><div class="step-number"><i class="fas fa-check"></i></div><div class="step-label">Position Details</div></div>
            <div class="connector active"></div>
            <div class="step complete"><div class="step-number"><i class="fas fa-check"></i></div><div class="step-label">Experience</div></div>
            <div class="connector active"></div>
            <div class="step active"><div class="step-number">4</div><div class="step-label">Review & Submit</div></div>
        </nav>

        <main class="form-container">
            <div class="form-header">
                <div class="form-icon"><i class="fas fa-file-signature"></i></div>
                <div class="form-title">
                    <h3>Review & Submit</h3>
                    <p>Please review your information and complete your application</p>
                </div>
            </div>

            <form class="application-form" id="final-form" novalidate>
                <div class="application-summary">
                    <h4>Application Summary</h4>
                    <div class="summary-grid">
                        <p><strong>Name:</strong></p><p id="summary-name">Loading...</p>
                        <p><strong>Position:</strong></p><p id="summary-position">Loading...</p>
                        <p><strong>Email:</strong></p><p id="summary-email">Loading...</p>
                        <p><strong>Availability:</strong></p><p id="summary-availability">Loading...</p>
                    </div>
                </div>

                <div class="form-group full-width" style="margin-top: 20px;">
                    <label>Required Documents</label>
                    <div class="file-upload-container">
                        <div class="file-upload-box">
                            <i class="fas fa-upload"></i>
                            <span id="resume-file-name">Resume/CV *</span>
                            <small>PDF, DOC (Max 5MB)</small>
                            <input type="file" id="resume-cv" name="resume-cv">
                        </div>
                        <div class="file-upload-box">
                            <i class="fas fa-upload"></i>
                            <span id="certificates-file-name">Certificates</span>
                            <small>PDF, JPG (Max 5MB)</small>
                            <input type="file" id="certificates-file" name="certificates">
                        </div>
                        <div class="file-upload-box">
                            <i class="fas fa-upload"></i>
                            <span id="valid-id-file-name">Valid ID *</span>
                            <small>PDF, JPG (Max 5MB)</small>
                            <input type="file" id="valid-id" name="valid-id">
                        </div>
                    </div>
                </div>

                <div class="consent-group">
                    <input type="checkbox" id="consent-background" name="consent-background">
                    <label for="consent-background">I consent to a background check.</label>
                </div>
                <div class="consent-group">
                    <input type="checkbox" id="consent-drug-test" name="consent-drug-test">
                    <label for="consent-drug-test">I consent to pre-employment drug testing.</label>
                </div>
                <div class="consent-group">
                    <input type="checkbox" id="consent-truthfulness" name="consent-truthfulness">
                    <label for="consent-truthfulness">I certify that the information provided is true and complete.</label>
                </div>
            </form>

            <div id="offline-overlay">
                <div>
                    <h1>You are Offline</h1>
                    <p>Please check your internet connection.</p>
                </div>
            </div>

            <footer class="form-footer">
                <a href="application3.html" class="btn btn-secondary"><i class="fas fa-arrow-left"></i> Previous</a>
                <button type="submit" form="final-form" id="submit-button" class="btn btn-success"><i class="fas fa-paper-plane"></i> Submit Application</button>
            </footer>
        </main>
    </div>

   <script>
    // --- 1. INITIALIZE SUPABASE ---
    const supabaseUrl = 'https://kkaelwhdcsgaodbhrxqt.supabase.co';
    const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImtrYWVsd2hkY3NnYW9kYmhyeHF0Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTYxOTA4NzksImV4cCI6MjA3MTc2Njg3OX0.wSFv1AZgZDXjGHiIwOHyWzqTDk0v6NbR4-2r90iF9ok';
    const { createClient } = supabase;
    const supabaseClient = createClient(supabaseUrl, supabaseKey);

    const applicationData = JSON.parse(localStorage.getItem('applicationData')) || {};
    document.getElementById('summary-name').textContent = `${applicationData.first_name || ''} ${applicationData.last_name || ''}`;
    document.getElementById('summary-email').textContent = applicationData.email || 'N/A';
    document.getElementById('summary-position').textContent = applicationData.desired_position || 'N/A';
    document.getElementById('summary-availability').textContent = applicationData.availability || 'N/A';

    // File name displays
    document.getElementById('resume-cv').addEventListener('change', (e) => { document.getElementById('resume-file-name').textContent = e.target.files[0]?.name || 'Resume/CV *'; });
    document.getElementById('certificates-file').addEventListener('change', (e) => { document.getElementById('certificates-file-name').textContent = e.target.files[0]?.name || 'Certificates'; });
    document.getElementById('valid-id').addEventListener('change', (e) => { document.getElementById('valid-id-file-name').textContent = e.target.files[0]?.name || 'Valid ID *'; });

    document.getElementById('final-form').addEventListener('submit', async function(event) {
        event.preventDefault();
        const submitButton = document.getElementById('submit-button');
        
        const consentBackground = document.getElementById('consent-background').checked;
        const consentDrugTest = document.getElementById('consent-drug-test').checked;
        const consentTruthfulness = document.getElementById('consent-truthfulness').checked;
        
        if (!consentBackground || !consentDrugTest || !consentTruthfulness) { 
            alert('Please agree to all consent statements.');
            return;
        }

        submitButton.disabled = true;
        submitButton.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Processing...';

        try {
            const email = applicationData.email;

            // 1. Check Duplicates & 3-Month Rule
            const { data: existingApps, error: fetchError } = await supabaseClient
                .from('applicants')
                .select('status, created_at')
                .eq('email', email)
                .order('created_at', { ascending: false })
                .limit(1);

            if (existingApps && existingApps.length > 0) {
                const latest = existingApps[0];
                if (latest.status !== 'Rejected') {
                    throw new Error(`You have an active application (${latest.status}).`);
                }
                const diff = Math.abs(new Date() - new Date(latest.created_at));
                if (diff / (1000 * 60 * 60 * 24 * 30.44) < 3) {
                    throw new Error("Rejected applicants must wait 3 months before applying again.");
                }
            }

            // 2. Upload Files
            const resumeFile = document.getElementById('resume-cv').files[0];
            const validIdFile = document.getElementById('valid-id').files[0];
            if (!resumeFile || !validIdFile) throw new Error('Missing files!');

            const ts = Date.now();
            await supabaseClient.storage.from('applicant-files').upload(`resumes/${ts}-${resumeFile.name}`, resumeFile);
            applicationData.resume_url = supabaseClient.storage.from('applicant-files').getPublicUrl(`resumes/${ts}-${resumeFile.name}`).data.publicUrl;

            await supabaseClient.storage.from('applicant-files').upload(`ids/${ts}-${validIdFile.name}`, validIdFile);
            applicationData.valid_id_url = supabaseClient.storage.from('applicant-files').getPublicUrl(`ids/${ts}-${validIdFile.name}`).data.publicUrl;

            // 3. Save Data
            applicationData.status = 'Pending';
            const { error: insErr } = await supabaseClient.from('applicants').insert([applicationData]);
            if (insErr) throw insErr;

            // 4. Email Notification
            try {
                await supabaseClient.functions.invoke('send-email', {
                    body: {
                        applicant_name: `${applicationData.first_name} ${applicationData.last_name}`,
                        applicant_email: applicationData.email,
                        position: applicationData.desired_position
                    }
                });
            } catch (e) {}

            alert('Submitted Successfully!');
            localStorage.removeItem('applicationData');
            window.location.href = 'index.html';

        } catch (error) {
            alert(error.message);
            submitButton.disabled = false;
            submitButton.innerHTML = 'Submit Application';
        }
    });

    const offlineOverlay = document.getElementById('offline-overlay');
    function updateOnlineStatus() { offlineOverlay.style.display = navigator.onLine ? 'none' : 'flex'; }
    window.addEventListener('online', updateOnlineStatus);
    window.addEventListener('offline', updateOnlineStatus);
    updateOnlineStatus();
</script>
</body>
</html>
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ALOHA Admin Pro | 2026 Modern Dashboard</title>
    
    <!-- 1. EXTERNAL RESOURCES -->
    <!-- Google Fonts: Plus Jakarta Sans is the standard for 2026 professional UIs -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    
    <!-- Bootstrap 5 for Layout -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    
    <!-- Font Awesome 6 for Modern Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- Heavy Libraries for Data and Visuals -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <style>
        /* --- 2. BRANDING & THEME VARIABLES --- */
        :root {
            --primary-red: #D2042D;
            --active-red: #A00322;
            --dark-slate: #0f172a;
            --text-main: #1e293b;
            --text-muted: #64748b;
            --background: #f8fafc;
            --sidebar-width: 280px;
            --sidebar-collapsed-width: 88px;
            /* Smooth timing for all animations */
            --transition-smooth: all 0.5s cubic-bezier(0.4, 0, 0.2, 1);
            --bento-radius: 24px;
            --shadow-sm: 0 10px 30px -5px rgba(0, 0, 0, 0.04);
            --shadow-lg: 0 25px 50px -12px rgba(0, 0, 0, 0.08);
        }

        /* --- 3. BASE RESET --- */
        * { 
            box-sizing: border-box; 
            margin: 0; 
            padding: 0; 
            font-family: 'Plus Jakarta Sans', sans-serif; 
        }
        
        body { 
            background-color: var(--background); 
            display: flex; 
            min-height: 100vh; 
            color: var(--text-main); 
            overflow-x: hidden; 
        }

        /* --- 4. SIDEBAR DESIGN (RETAINED STYLE) --- */
        .sidebar { 
            width: var(--sidebar-width); 
            background-color: var(--primary-red); 
            color: white; 
            display: flex; 
            flex-direction: column; 
            position: fixed; 
            height: 100vh; 
            z-index: 1100; 
            transition: var(--transition-smooth);
            box-shadow: 10px 0 30px rgba(0,0,0,0.05);
        }

        .sidebar-logo { 
            padding: 40px 15px; 
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: flex-start;
            gap: 20px;
            transition: var(--transition-smooth);
        }

        .sidebar-toggle-btn {
            color: white;
            cursor: pointer;
            background: rgba(0,0,0,0.1);
            width: 48px;
            height: 48px;
            border-radius: 16px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: 0.3s;
            font-size: 1.2rem;
            border: 1px solid rgba(255,255,255,0.1);
        }

        .sidebar-toggle-btn:hover { 
            background: rgba(0,0,0,0.2); 
            transform: scale(1.05); 
        }

        .sidebar-logo img { 
            width: 95px; 
            height: 95px; 
            border-radius: 30px; 
            border: 6px solid rgba(255,255,255,0.2); 
            background: white; 
            object-fit: cover;
            transition: var(--transition-smooth);
            box-shadow: 0 15px 30px rgba(0,0,0,0.2);
        }

        .sidebar-logo h2 {
            font-size: 1.5rem;
            font-weight: 800;
            letter-spacing: 4px;
            margin: 0;
            transition: var(--transition-smooth);
        }

        /* Sidebar States */
        .sidebar.collapsed { width: var(--sidebar-collapsed-width); }
        .sidebar.collapsed .sidebar-logo h2, 
        .sidebar.collapsed .nav-item span { display: none; opacity: 0; }
        .sidebar.collapsed .sidebar-logo img { width: 55px; height: 55px; border-radius: 15px; }
        .sidebar.collapsed .nav-item { justify-content: center; padding: 20px 0; }

        .nav-item { 
            padding: 16px 30px; 
            color: rgba(255,255,255,0.7); 
            text-decoration: none !important; 
            display: flex; 
            align-items: center; 
            gap: 15px; 
            cursor: pointer; 
            transition: var(--transition-smooth);
            font-weight: 600;
            margin: 4px 15px;
            border-radius: 18px;
        }

        .nav-item i { width: 25px; font-size: 1.2rem; text-align: center; }
        .nav-item:hover { background: rgba(255, 255, 255, 0.1); color: white; }
        .nav-item.active { 
            background: white; 
            color: var(--primary-red); 
            box-shadow: 0 10px 20px rgba(0,0,0,0.1); 
        }

        /* --- 5. CONTENT AREA WRAPPER --- */
        .main-content { 
            margin-left: var(--sidebar-width); 
            flex: 1; 
            display: flex; 
            flex-direction: column; 
            width: 100%; 
            transition: var(--transition-smooth); 
        }

        .main-content.sidebar-collapsed { margin-left: var(--sidebar-collapsed-width); }

        .header-bar { 
            background: rgba(255, 255, 255, 0.8); 
            backdrop-filter: blur(15px);
            padding: 0 45px; 
            height: 100px;
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            position: sticky; 
            top: 0; 
            z-index: 100; 
            border-bottom: 1px solid rgba(0,0,0,0.04);
        }

        /* --- 6. MODERN BENTO COMPONENTS --- */
        .content-body { padding: 45px; max-width: 1600px; margin: 0 auto; width: 100%; }

        /* Modern Bento Stat Cards */
        .stat-card { 
            background: white; 
            padding: 30px; 
            border-radius: var(--bento-radius); 
            box-shadow: var(--shadow-sm);
            transition: var(--transition-smooth); 
            height: 100%; 
            border: 1px solid rgba(0,0,0,0.03);
            display: flex;
            flex-direction: column;
            position: relative;
            overflow: hidden;
        }

        .stat-card:hover { 
            transform: translateY(-8px) scale(1.02); 
            box-shadow: var(--shadow-lg); 
            border-color: rgba(210, 4, 45, 0.1);
        }

        /* Icons inside the stats */
        .stat-icon-box {
            width: 55px; height: 55px;
            border-radius: 18px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 25px;
            font-size: 1.4rem;
            transition: 0.5s ease;
        }

        .stat-card:hover .stat-icon-box {
            transform: rotate(-10deg) scale(1.1);
        }

        /* Icon Colors */
        .icon-red { background: #fee2e2; color: #dc2626; }
        .icon-orange { background: #fef3c7; color: #d97706; }
        .icon-green { background: #dcfce7; color: #16a34a; }
        .icon-blue { background: #dbeafe; color: #2563eb; }

        .stat-card .value { 
            font-size: 44px; 
            font-weight: 900; 
            margin: 0; 
            color: var(--dark-slate); 
            line-height: 1; 
            letter-spacing: -1.5px;
        }

        .stat-card h4 { 
            color: var(--text-muted); 
            font-size: 0.8rem; 
            text-transform: uppercase; 
            letter-spacing: 1.5px; 
            font-weight: 800; 
            margin-bottom: 8px; 
        }
        
        /* General Bento Box container for Charts/Tables */
        .bento-box { 
            background: white; 
            border-radius: var(--bento-radius); 
            box-shadow: var(--shadow-sm); 
            overflow: hidden; 
            border: 1px solid rgba(0,0,0,0.03);
            padding: 35px;
            transition: 0.3s ease;
        }

        .bento-box:hover { box-shadow: var(--shadow-lg); }

        /* --- 7. UI ELEMENTS (TABLES & BUTTONS) --- */
        .badge-pending { background: #fef3c7; color: #92400e; padding: 10px 20px; border-radius: 14px; font-size: 12px; font-weight: 700; }
        .badge-approved { background: #dcfce7; color: #166534; padding: 10px 20px; border-radius: 14px; font-size: 12px; font-weight: 700; }
        .badge-rejected { background: #fee2e2; color: #991b1b; padding: 10px 20px; border-radius: 14px; font-size: 12px; font-weight: 700; }

        .btn-action {
            width: 42px; height: 42px;
            border-radius: 14px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            transition: 0.2s ease-in-out;
            border: none;
            font-size: 1rem;
        }
        .btn-view { background: #f1f5f9; color: #64748b; }
        .btn-view:hover { background: var(--primary-red); color: white; transform: translateY(-2px); }
        .btn-delete { background: #fff1f2; color: #e11d48; }
        .btn-delete:hover { background: #e11d48; color: white; transform: translateY(-2px); }

        /* --- 8. BRANCH ACCORDIONS --- */
        .branch-accordion { 
            margin-bottom: 25px; 
            border-radius: 24px; 
            overflow: hidden; 
            background: white; 
            border: 1px solid rgba(0,0,0,0.05); 
            transition: 0.4s; 
        }
        .accordion-header-custom { 
            padding: 30px; 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            cursor: pointer; 
            font-weight: 700; 
            font-size: 1.1rem;
        }
        .accordion-content { 
            max-height: 0; 
            overflow: hidden; 
            transition: 0.6s cubic-bezier(0.16, 1, 0.3, 1); 
            background: #fafafa; 
        }
        .accordion-content.active { 
            max-height: 2500px; 
            border-top: 1px solid #f1f5f9; 
        }

        /* --- 9. MODALS & FORMS --- */
        .modal-overlay { 
            position: fixed; 
            inset: 0; 
            background: rgba(15, 23, 42, 0.7); 
            backdrop-filter: blur(10px); 
            display: none; 
            justify-content: center; 
            align-items: center; 
            z-index: 3000; 
        }
        .modal-box { 
            background: white; 
            width: 95%; 
            max-width: 480px; 
            padding: 60px; 
            border-radius: 40px; 
            text-align: center; 
            box-shadow: 0 40px 80px rgba(0,0,0,0.4); 
            animation: modalPop 0.6s cubic-bezier(0.34, 1.56, 0.64, 1); 
        }
        @keyframes modalPop { 
            from { transform: scale(0.8); opacity: 0; } 
            to { transform: scale(1); opacity: 1; } 
        }
        .modal-overlay.active { display: flex; }

        .form-control, .form-select { 
            border-radius: 16px; 
            padding: 15px 20px; 
            border: 1px solid #e2e8f0; 
            font-weight: 500; 
            transition: 0.3s; 
        }
        .form-control:focus { 
            box-shadow: 0 0 0 5px rgba(210, 4, 45, 0.1); 
            border-color: var(--primary-red); 
        }

        .hidden { display: none; }

        @media (max-width: 992px) {
            .sidebar { left: -280px; }
            .sidebar.open { left: 0; }
            .main-content { margin-left: 0 !important; }
            .menu-toggle-mobile { display: block !important; cursor: pointer; font-size: 2rem; color: var(--primary-red); }
        }
    </style>
</head>
<body>

    <!-- 10. NOTIFICATION & SYSTEM MODALS -->
    <!-- Confirmation Dialog (Delete, Logout, Restore) -->
    <div id="customModal" class="modal-overlay">
        <div class="modal-box">
            <div id="modalIcon" style="font-size: 80px; color: var(--primary-red); margin-bottom: 30px;"><i class="fas fa-circle-exclamation"></i></div>
            <h2 id="modalTitle" style="font-weight: 800; color: var(--dark-slate); letter-spacing: -0.5px;">System Alert</h2>
            <p id="modalText" style="color: var(--text-muted); margin: 20px 0 40px; line-height: 1.7; font-size: 1.1rem;">Please confirm your action.</p>
            <div class="d-flex justify-content-center gap-3">
                <button id="cancelBtn" class="btn btn-light px-5 py-3 fw-bold" style="border-radius: 18px; border: 1px solid #e2e8f0;">Cancel</button>
                <button id="confirmBtn" class="btn btn-danger px-5 py-3 fw-bold" style="background: var(--primary-red); border-radius: 18px; border: none; box-shadow: 0 10px 25px rgba(210, 4, 45, 0.2);">Proceed</button>
            </div>
        </div>
    </div>

    <!-- Personnel Registration Modal -->
    <div id="manualAddModal" class="modal-overlay">
        <div class="modal-box text-start" style="max-width: 550px;">
            <h2 class="mb-4 text-center" style="color: var(--dark-slate); font-weight: 800; letter-spacing: -1px;">New Registration</h2>
            <div class="mb-3">
                <label class="form-label fw-bold small text-muted text-uppercase">Given Name</label>
                <input type="text" id="m_first_name" class="form-control" placeholder="Type first name...">
            </div>
            <div class="mb-3">
                <label class="form-label fw-bold small text-muted text-uppercase">Surname</label>
                <input type="text" id="m_last_name" class="form-control" placeholder="Type last name...">
            </div>
            <div class="mb-3">
                <label class="form-label fw-bold small text-muted text-uppercase">Designated Role</label>
                <select id="m_position" class="form-select">
                    <option value="Security Guard">Security Guard</option>
                    <option value="Security Supervisor">Security Supervisor</option>
                    <option value="Mobile Patrol">Mobile Patrol</option>
                </select>
            </div>
            <div class="mb-4">
                <label class="form-label fw-bold small text-muted text-uppercase">Deployment Branch</label>
                <select id="m_branch" class="form-select">
                    <option value="">Stay in Pending Queue</option>
                    <option value="Manila Main">Manila Main</option>
                    <option value="Quezon City">Quezon City</option>
                    <option value="Makati Hub">Makati Hub</option>
                    <option value="Davao Branch">Davao Branch</option>
                    <option value="Cebu Office">Cebu Office</option>
                </select>
            </div>
            <div class="d-flex justify-content-center gap-3">
                <button onclick="closeManualAdd()" class="btn btn-light w-50 py-3 fw-bold" style="border-radius: 18px;">Close</button>
                <button onclick="saveManualEmployee()" class="btn btn-danger w-50 py-3 fw-bold" style="background: var(--primary-red); border-radius: 18px; border: none;">Save Personnel</button>
            </div>
        </div>
    </div>

    <!-- 11. SIDEBAR STRUCTURE -->
    <aside class="sidebar" id="sidebar">
        <div class="sidebar-logo">
            <div class="sidebar-toggle-btn d-none d-lg-flex" onclick="toggleSidebarDesktop()">
                <i class="fas fa-bars-staggered"></i>
            </div>
            <img src="Resources/logo.jpg" alt="Aloha Security Logo">
            <h2 class="mt-2 text-uppercase">ALOHA</h2>
        </div>
        
        <nav class="mt-4 flex-grow-1">
            <div class="nav-item active" onclick="switchTab('dashboard-tab', this)"><i class="fas fa-grip-vertical"></i> <span>Dashboard</span></div>
            <div class="nav-item" onclick="switchTab('applicants-tab', this)"><i class="fas fa-users-viewfinder"></i> <span>Applications</span></div>
            <div class="nav-item" onclick="switchTab('branches-tab', this)"><i class="fas fa-map-location-dot"></i> <span>Branch View</span></div>
            <div class="nav-item" onclick="switchTab('trash-tab', this)"><i class="fas fa-trash-can"></i> <span>Trash Bin</span></div>
        </nav>
        
        <div class="pb-5">
            <div class="nav-item" onclick="handleLogout()" style="background: rgba(0,0,0,0.1); margin-top: 25px;">
                <i class="fas fa-power-off"></i> <span>Logout System</span>
            </div>
        </div>
    </aside>

    <!-- 12. MAIN CONTENT INTERFACE -->
    <main class="main-content">
        <!-- Persistent Header Bar -->
        <header class="header-bar">
            
            <h3 id="current-title" style="color: var(--dark-slate); font-weight: 800; margin: 0; letter-spacing: -1px;">DASHBOARD</h3>
            
            <div class="d-flex align-items-center">
                <!-- Notifications Bell -->
                <div class="dropdown me-4">
                    <div class="notification-wrapper" style="cursor: pointer; position: relative; padding: 12px; background: #f1f5f9; border-radius: 16px;" data-bs-toggle="dropdown">
                        <i class="fas fa-bell fs-5 text-secondary"></i>
                        <span id="notif-badge" class="badge rounded-circle bg-danger position-absolute" style="top: 8px; right: 8px; width: 22px; height: 22px; display: none; align-items: center; justify-content: center; font-size: 10px; border: 3px solid white;">0</span>
                    </div>
                    <div class="dropdown-menu dropdown-menu-end shadow-lg border-0" style="width: 380px; border-radius: 20px; padding: 0; overflow: hidden; margin-top: 15px;">
                        <div class="p-4 bg-dark text-white fw-bold">Recent Submissions</div>
                        <div id="notif-list-items" style="max-height: 400px; overflow-y: auto;"></div>
                        <div class="p-3 text-center bg-light border-top">
                            <a href="#" onclick="switchTab('applicants-tab', document.querySelectorAll('.nav-item')[1])" class="fw-bold text-decoration-none text-danger small">Show All Queue</a>
                        </div>
                    </div>
                </div>

                <!-- Admin Profile Info -->
                <div class="d-flex align-items-center gap-3 border-start ps-4">
                    <div class="text-end d-none d-md-block">
                        <span class="fw-bold small d-block" style="color: var(--dark-slate);">ROOT ADMIN</span>
                        <span class="text-success fw-bold" style="font-size: 0.7rem;">ACTIVE SESSION</span>
                    </div>
                    <div style="width: 55px; height: 55px; background: #f1f5f9; border-radius: 18px; display: flex; align-items: center; justify-content: center; border: 1px solid #e2e8f0;">
                        <i class="fas fa-shield-halved text-secondary fs-4"></i>
                    </div>
                </div>
            </div>
        </header>

        <div class="content-body">
            <!-- --- TAB 1: MODERN DASHBOARD --- -->
            <section id="dashboard-tab">
                <!-- Top Stats Bento Grid -->
                <div class="row g-4 mb-5">
                    <div class="col-md-3">
                        <div class="stat-card">
                            <div class="stat-icon-box icon-red"><i class="fas fa-database"></i></div>
                            <h4>Database Total</h4>
                            <div class="value" id="stat-total">0</div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="stat-card">
                            <div class="stat-icon-box icon-orange"><i class="fas fa-clock-rotate-left"></i></div>
                            <h4>Waiting Review</h4>
                            <div class="value text-warning" id="stat-pending">0</div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="stat-card">
                            <div class="stat-icon-box icon-green"><i class="fas fa-user-check"></i></div>
                            <h4>Deployed Guards</h4>
                            <div class="value text-success" id="stat-approved">0</div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="stat-card">
                            <div class="stat-icon-box icon-blue"><i class="fas fa-bolt-lightning"></i></div>
                            <h4>New Today</h4>
                            <div class="value text-primary" id="stat-today-count">0</div>
                        </div>
                    </div>
                </div>

                <!-- Visual Charts Grid -->
                <div class="row g-4">
                    <div class="col-lg-8">
                        <div class="bento-box h-100">
                            <div class="d-flex justify-content-between align-items-center mb-5">
                                <h5 class="fw-bold m-0"><i class="fas fa-chart-simple me-3 text-danger"></i>Branch Deployment Stats</h5>
                                <span class="badge bg-light text-muted fw-bold px-3 py-2 border">Live Real-time</span>
                            </div>
                            <div style="height: 420px;"><canvas id="branchChart"></canvas></div>
                        </div>
                    </div>
                    <div class="col-lg-4">
                        <div class="bento-box mb-4">
                            <h5 class="fw-bold mb-4"><i class="fas fa-scroll me-3 text-primary"></i>System Activities</h5>
                            <div id="activity-log" style="max-height: 240px; overflow-y: auto;">
                                <div class="p-3 bg-light rounded-4 mb-2 small fw-bold text-muted">Awaiting activity logs...</div>
                            </div>
                        </div>
                        <div class="bento-box">
                            <h5 class="fw-bold mb-4"><i class="fas fa-chart-pie me-3 text-success"></i>Status Ratio</h5>
                            <div style="height: 250px;"><canvas id="statusChart"></canvas></div>
                        </div>
                    </div>
                </div>
            </section>

            <!-- --- TAB 2: PERSONNEL MANAGEMENT --- -->
            <section id="applicants-tab" class="hidden">
                <div class="bento-box p-0">
                    <!-- Filter and Search Header -->
                    <div class="p-4 d-md-flex justify-content-between align-items-center border-bottom bg-white">
                        <div class="d-flex align-items-center gap-3">
                            <h4 class="fw-bold m-0">Management Queue</h4>
                            <button class="btn btn-danger px-4 py-2 fw-bold shadow-sm" style="background: var(--primary-red); border-radius: 14px; border:none;" onclick="openManualAdd()"><i class="fas fa-plus-circle me-2"></i>Register Personnel</button>
                        </div>
                        <div class="d-flex gap-3 mt-3 mt-md-0">
                            <select id="statusFilter" class="form-select rounded-pill shadow-sm" style="width: 170px; font-weight: 600;" onchange="updateUI()">
                                <option value="pending" selected>Filter: Pending</option>
                                <option value="approved">Filter: Approved</option>
                                <option value="all">View All Active</option>
                            </select>
                            <div class="position-relative">
                                <i class="fas fa-magnifying-glass position-absolute" style="left: 20px; top: 16px; color: var(--text-muted);"></i>
                                <input type="text" id="searchInput" class="form-control ps-5 rounded-pill shadow-sm" placeholder="Search by name..." oninput="updateUI()" style="width: 320px;">
                            </div>
                        </div>
                    </div>
                    <!-- Queue Table -->
                    <div class="table-responsive">
                        <table class="table table-hover align-middle mb-0">
                            <thead class="bg-light border-bottom">
                                <tr>
                                    <th class="ps-5 py-4 text-muted fw-bold small text-uppercase">Full Identity</th>
                                    <th class="text-muted fw-bold small text-uppercase">Desired Role</th>
                                    <th class="text-muted fw-bold small text-uppercase">System Status</th>
                                    <th class="text-center text-muted fw-bold small text-uppercase">Operations</th>
                                </tr>
                            </thead>
                            <tbody id="applicant-table-body"></tbody>
                        </table>
                    </div>
                </div>
            </section>

            <!-- --- TAB 3: LOCATION OPERATIONS --- -->
            <section id="branches-tab" class="hidden">
                <div class="mb-5">
                    <h3 class="fw-bold m-0">Branch Operations</h3>
                    <p class="text-muted">Overview of guards currently deployed at each station.</p>
                </div>
                <!-- Dynamic branch containers load here -->
                <div id="branch-accordion-container" class="row"></div>
            </section>

            <!-- --- TAB 4: RECOVERY SYSTEM --- -->
            <section id="trash-tab" class="hidden">
                <div class="d-flex justify-content-between align-items-center mb-5">
                    <div>
                        <h3 class="fw-bold m-0">Trash & Recovery</h3>
                        <p class="text-muted small mb-0"><i class="fas fa-circle-info me-2 text-primary"></i>Records here will be permanently erased after 3 days.</p>
                    </div>
                    <button id="bulk-delete-btn" class="btn btn-danger rounded-4 fw-bold px-4 py-3 shadow-sm" onclick="bulkDeleteTrash()"><i class="fas fa-dumpster-fire me-2"></i>Erase Selected Records</button>
                </div>
                <div class="bento-box p-0">
                    <div class="table-responsive">
                        <table class="table table-hover align-middle mb-0">
                            <thead class="bg-light border-bottom">
                                <tr>
                                    <th class="ps-5" style="width: 80px;"><input type="checkbox" id="select-all-trash" class="form-check-input" onclick="toggleSelectAllTrash(this)"></th>
                                    <th class="text-muted fw-bold small text-uppercase">Personnel Name</th>
                                    <th class="text-muted fw-bold small text-uppercase">Last Position</th>
                                    <th class="text-muted fw-bold small text-uppercase">Reason/Tag</th>
                                    <th class="text-center text-muted fw-bold small text-uppercase">Recovery Ops</th>
                                </tr>
                            </thead>
                            <tbody id="trash-table-body"></tbody>
                        </table>
                    </div>
                </div>
            </section>
        </div>
    </main>

    <!-- 13. SYSTEM CORE SCRIPT -->
    <script>
        /**
         * 1. DATABASE CONFIGURATION
         * Connecting to Supabase backend to fetch data.
         */
        const supabaseUrl = 'https://kkaelwhdcsgaodbhrxqt.supabase.co';
        const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImtrYWVsd2hkY3NnYW9kYmhyeHF0Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTYxOTA4NzksImV4cCI6MjA3MTc2Njg3OX0.wSFv1AZgZDXjGHiIwOHyWzqTDk0v6NbR4-2r90iF9ok';
        const _supabase = supabase.createClient(supabaseUrl, supabaseKey);

        let masterData = [];
        const branchOptions = ["Manila Main", "Quezon City", "Makati Hub", "Davao Branch", "Cebu Office"];

        /**
         * 2. SIDEBAR NAVIGATION LOGIC
         */
        function toggleSidebarDesktop() {
            const sidebar = document.getElementById('sidebar');
            const main = document.querySelector('.main-content');
            sidebar.classList.toggle('collapsed');
            main.classList.toggle('sidebar-collapsed');
            // Refresh charts after resizing sidebar for visual consistency
            setTimeout(() => { if(window.bChart) renderCharts(); }, 500);
        }

        function toggleSidebarMobile() {
            document.getElementById('sidebar').classList.toggle('open');
        }

        function switchTab(id, el) {
            document.querySelectorAll('section').forEach(s => s.classList.add('hidden'));
            document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
            document.getElementById(id).classList.remove('hidden');
            el.classList.add('active');
            document.getElementById('current-title').innerText = el.innerText.toUpperCase();
            if (window.innerWidth <= 992) document.getElementById('sidebar').classList.remove('open');
        }

        /**
         * 3. DATA FETCHING & STATE MANAGEMENT
         */
        async function fetchData() {
            const { data, error } = await _supabase.from('applicants').select('*').order('created_at', { ascending: false });
            if (error) return console.error("Database Error:", error);
            
            masterData = data;
            
            // AUTOMATIC TRASH PURGE: Delete rejected records older than 3 days.
            const now = new Date();
            const trashItems = masterData.filter(a => a.status?.toLowerCase() === 'rejected');
            for (let item of trashItems) {
                const rejectedDate = new Date(item.updated_at || item.created_at);
                if (Math.ceil((now - rejectedDate) / (1000 * 60 * 60 * 24)) >= 3) {
                    await _supabase.from('applicants').delete().eq('id', item.id);
                }
            }
            
            updateUI(); // Refresh the visual interface
        }

        /**
         * 4. UI RE-RENDERING ENGINE
         */
        function updateUI() {
            const pendingApps = masterData.filter(a => a.status?.toLowerCase() === 'pending');
            const now = new Date();
            const todayApps = masterData.filter(a => (now - new Date(a.created_at)) < (24 * 60 * 60 * 1000));
            
            // Update Dashboard Stat Counters
            document.getElementById('stat-total').innerText = masterData.length;
            document.getElementById('stat-pending').innerText = pendingApps.length;
            document.getElementById('stat-approved').innerText = masterData.filter(a => a.status?.toLowerCase() === 'approved').length;
            document.getElementById('stat-today-count').innerText = todayApps.length;
            
            // Handle Notification System
            const badge = document.getElementById('notif-badge');
            const notifList = document.getElementById('notif-list-items');
            if(pendingApps.length > 0) {
                badge.innerText = pendingApps.length;
                badge.style.display = 'flex';
                notifList.innerHTML = pendingApps.slice(0, 5).map(app => `
                    <a class="p-3 border-bottom d-block text-decoration-none hover-light" style="cursor: pointer;" onclick="window.location.href='view-applicant.html?id=${app.id}'">
                        <div class="fw-bold text-danger small">${app.first_name} ${app.last_name}</div>
                        <div class="text-muted" style="font-size: 0.75rem;">Submitted for: ${app.desired_position}</div>
                    </a>`).join('');
            } else {
                badge.style.display = 'none';
                notifList.innerHTML = '<div class="p-5 text-center text-muted small fw-bold">Queue is currently clear.</div>';
            }

            // Table Filter and Search Logic
            const filterVal = document.getElementById('statusFilter').value;
            const searchVal = document.getElementById('searchInput').value.toLowerCase();
            let filtered = masterData.filter(a => a.status?.toLowerCase() !== 'rejected');

            if (filterVal === 'pending') filtered = filtered.filter(a => a.status?.toLowerCase() === 'pending');
            else if (filterVal === 'approved') filtered = filtered.filter(a => a.status?.toLowerCase() === 'approved');

            if (searchVal) filtered = filtered.filter(a => (a.first_name + ' ' + a.last_name).toLowerCase().includes(searchVal));

            // Execute rendering sub-functions
            renderTableRows(filtered);
            renderCharts();
            renderAccordions();
            renderTrashBin();
        }

        /**
         * 5. LIST RENDERING FUNCTIONS
         */
        function renderTableRows(list) {
            const tbody = document.getElementById('applicant-table-body');
            if (list.length === 0) {
                tbody.innerHTML = `<tr><td colspan="4" class="text-center text-muted py-5 fw-bold fs-5">No records matching the filter.</td></tr>`;
                return;
            }
            tbody.innerHTML = list.map(app => {
                const dateStr = new Date(app.created_at).toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
                return `
                    <tr style="transition: 0.2s;">
                        <td class="ps-5 py-4">
                            <div class="fw-bold" style="color: var(--dark-slate);">${app.first_name} ${app.last_name}</div>
                            <div class="text-muted" style="font-size: 0.75rem; font-weight: 700;">REGISTRATION: ${dateStr}</div>
                        </td>
                        <td class="fw-bold text-secondary" style="font-size: 0.95rem;">${app.desired_position || 'Not Assigned'}</td>
                        <td><span class="badge-${app.status?.toLowerCase()}">${app.status.toUpperCase()}</span></td>
                        <td class="text-center">
                            <button class="btn-action btn-view me-2" onclick="window.location.href='view-applicant.html?id=${app.id}'" title="View Identity"><i class="fas fa-eye"></i></button>
                            <button class="btn-action btn-delete" onclick="deleteApp('${app.id}')" title="Move to Trash Bin"><i class="fas fa-trash-can"></i></button>
                        </td>
                    </tr>`;
            }).join('');
        }

        function renderAccordions() {
            const container = document.getElementById('branch-accordion-container');
            container.innerHTML = branchOptions.map(branch => {
                const guards = masterData.filter(a => a.assigned_branch === branch && a.status === 'Approved');
                return `
                    <div class="col-md-6 mb-4">
                        <div class="branch-accordion shadow-sm">
                            <div class="accordion-header-custom bg-white" onclick="this.nextElementSibling.classList.toggle('active')">
                                <span class="d-flex align-items-center"><i class="fas fa-location-dot text-danger me-3 fs-5"></i> ${branch}</span>
                                <div class="d-flex align-items-center gap-3">
                                    <span class="badge bg-light text-secondary fw-bold border" style="font-size: 0.75rem; padding: 6px 15px; border-radius: 10px;">${guards.length} ON SITE</span>
                                    <i class="fas fa-chevron-down small text-muted"></i>
                                </div>
                            </div>
                            <div class="accordion-content">
                                <div class="p-3 bg-white">
                                    ${guards.map(g => `
                                        <div class="d-flex justify-content-between align-items-center p-3 border-bottom border-light">
                                            <span class="small fw-bold text-dark"><i class="fas fa-id-card-clip me-3 text-secondary"></i> ${g.first_name} ${g.last_name}</span>
                                            <button onclick="unassign('${g.id}')" class="btn btn-link btn-sm text-danger fw-bold p-0 text-decoration-none" style="font-size: 0.7rem;">
                                                UNASSIGN
                                            </button>
                                        </div>`).join('') || '<div class="text-center py-5 text-muted small fw-bold opacity-50">LOCATION CURRENTLY VACANT</div>'}
                                </div>
                            </div>
                        </div>
                    </div>`;
            }).join('');
        }

        function renderTrashBin() {
            const tbody = document.getElementById('trash-table-body');
            const trashList = masterData.filter(a => a.status?.toLowerCase() === 'rejected');
            document.getElementById('select-all-trash').checked = false;
            const bulkBtn = document.getElementById('bulk-delete-btn');
            if (bulkBtn) bulkBtn.style.visibility = 'hidden';

            if(trashList.length === 0) {
                tbody.innerHTML = `<tr><td colspan="5" class="text-center text-muted py-5 fw-bold fs-5">Trash repository is empty.</td></tr>`;
                return;
            }

            tbody.innerHTML = trashList.map(app => `
                <tr>
                    <td class="ps-5 py-4"><input type="checkbox" class="trash-check form-check-input" data-id="${app.id}" onclick="updateTrashBulkUI()"></td>
                    <td class="fw-bold text-dark">${app.first_name} ${app.last_name}</td>
                    <td class="small fw-bold text-secondary">${app.desired_position}</td>
                    <td><span class="badge-rejected">DELETED ITEM</span></td>
                    <td class="text-center">
                        <button class="btn btn-sm btn-light text-primary me-2 fw-bold px-4 py-2 border rounded-3" onclick="restoreApplicant('${app.id}')">RESTORE</button>
                        <button class="btn btn-sm btn-danger fw-bold px-4 py-2 rounded-3 shadow-sm" onclick="deleteApp('${app.id}')">ERASE</button>
                    </td>
                </tr>`).join('');
        }

        /**
         * 6. SYSTEM ACTIONS & CONFIRMATION OVERLAYS
         */
        async function askModal(title, text, confirmText = "Confirm") {
            return new Promise((resolve) => {
                const overlay = document.getElementById('customModal');
                const iconDiv = document.getElementById('modalIcon');
                const confirmBtn = document.getElementById('confirmBtn');
                const icon = iconDiv.querySelector('i');
                
                document.getElementById('modalTitle').innerText = title;
                document.getElementById('modalText').innerText = text;
                confirmBtn.innerText = confirmText;
                
                // Visual Switch for icons based on title
                if(title.includes('Restore')) {
                    icon.className = 'fas fa-arrows-rotate';
                    iconDiv.style.color = '#10b981';
                    confirmBtn.style.background = '#10b981'; 
                } else if (title.includes('Logout')) {
                    icon.className = 'fas fa-power-off';
                    iconDiv.style.color = 'var(--primary-red)';
                    confirmBtn.style.background = 'var(--primary-red)';
                } else {
                    icon.className = 'fas fa-circle-exclamation';
                    iconDiv.style.color = 'var(--primary-red)';
                    confirmBtn.style.background = 'var(--primary-red)';
                }

                overlay.classList.add('active');
                confirmBtn.onclick = () => { overlay.classList.remove('active'); resolve(true); };
                document.getElementById('cancelBtn').onclick = () => { overlay.classList.remove('active'); resolve(false); };
            });
        }

        async function deleteApp(id) {
            const yes = await askModal("Erase Record?", "Are you sure? This personnel will be permanently deleted.", "Yes, Erase");
            if (yes) {
                await _supabase.from('applicants').delete().eq('id', id);
                logActivity(`System Log: Permanently erased record ID ${id}`);
                fetchData();
            }
        }

        async function unassign(id) {
            const yes = await askModal("Unassign Personnel?", "Remove this guard from the branch? They will return to the Pending queue.", "Unassign Now");
            if (yes) {
                await _supabase.from('applicants').update({ assigned_branch: null, status: 'Pending' }).eq('id', id);
                logActivity(`Action: Unassigned personnel ID ${id}`);
                fetchData();
            }
        }

        async function restoreApplicant(id) {
            const yes = await askModal("Restore Identity?", "Move this personnel back to the active queue?", "Yes, Restore");
            if(yes) {
                await _supabase.from('applicants').update({ status: 'Pending' }).eq('id', id);
                logActivity(`Action: Restored rejected ID ${id}`);
                fetchData();
            }
        }

        async function handleLogout() {
            if(await askModal("Logout Session?", "Are you ready to end your session?", "Logout Now")) {
                await _supabase.auth.signOut();
                window.location.href = 'AdminLogin.html';
            }
        }

        /**
         * 7. BULK OPERATION LOGIC
         */
        function toggleSelectAllTrash(source) { 
            document.querySelectorAll('.trash-check').forEach(cb => cb.checked = source.checked); 
            updateTrashBulkUI(); 
        }

        function updateTrashBulkUI() { 
            const count = document.querySelectorAll('.trash-check:checked').length; 
            const bulkBtn = document.getElementById('bulk-delete-btn');
            if (bulkBtn) bulkBtn.style.visibility = count > 0 ? 'visible' : 'hidden'; 
        }

        async function bulkDeleteTrash() {
            const ids = Array.from(document.querySelectorAll('.trash-check:checked')).map(cb => cb.getAttribute('data-id'));
            if(await askModal("Purge Trash?", `Permanently delete ${ids.length} selected records?`, "Purge All")) {
                await _supabase.from('applicants').delete().in('id', ids);
                logActivity(`Bulk Action: Purged ${ids.length} items.`);
                fetchData();
            }
        }

        /**
         * 8. MANUAL REGISTRATION FLOW
         */
        function openManualAdd() { document.getElementById('manualAddModal').classList.add('active'); }
        function closeManualAdd() { document.getElementById('manualAddModal').classList.remove('active'); }

        async function saveManualEmployee() {
            const fname = document.getElementById('m_first_name').value.trim();
            const lname = document.getElementById('m_last_name').value.trim();
            if(!fname || !lname) return alert("Full name is required.");
            
            await _supabase.from('applicants').insert([{ 
                first_name: fname, 
                last_name: lname, 
                desired_position: document.getElementById('m_position').value, 
                assigned_branch: document.getElementById('m_branch').value || null, 
                status: document.getElementById('m_branch').value ? 'Approved' : 'Pending' 
            }]);
            
            logActivity(`Admin: Registered ${fname} ${lname}`);
            closeManualAdd(); 
            fetchData();
        }

        function logActivity(msg) {
            const log = document.getElementById('activity-log');
            const div = document.createElement('div'); 
            div.className = 'p-3 bg-light rounded-4 mb-3 small fw-bold border-start border-danger border-4';
            div.innerHTML = `<div>${msg}</div><div class="text-muted opacity-50 mt-1" style="font-size: 0.65rem;">TIME: ${new Date().toLocaleTimeString()}</div>`;
            log.prepend(div);
        }

        /**
         * 9. ANALYTICS & CHART RENDERING
         */
        function renderCharts() {
            const ctx1 = document.getElementById('branchChart').getContext('2d');
            const ctx2 = document.getElementById('statusChart').getContext('2d');
            
            // Avoid double rendering errors
            if (window.bChart) window.bChart.destroy();
            if (window.sChart) window.sChart.destroy();
            
            // Bar Chart: Branch Counts
            window.bChart = new Chart(ctx1, { 
                type: 'bar', 
                data: { 
                    labels: branchOptions, 
                    datasets: [{ 
                        label: 'Personnel Count', 
                        data: branchOptions.map(b => masterData.filter(a => a.assigned_branch === b).length), 
                        backgroundColor: '#D2042D', 
                        borderRadius: 14,
                        barThickness: 50 
                    }] 
                }, 
                options: { 
                    maintainAspectRatio: false, 
                    plugins: { legend: { display: false } }, 
                    scales: { 
                        y: { beginAtZero: true, grid: { color: '#f1f5f9' }, border: {display: false} }, 
                        x: { grid: { display: false }, border: {display: false} } 
                    } 
                } 
            });
            
            // Doughnut Chart: Ratio
            window.sChart = new Chart(ctx2, { 
                type: 'doughnut', 
                data: { 
                    labels: ['Pending', 'Approved', 'Rejected'], 
                    datasets: [{ 
                        data: [
                            masterData.filter(a => a.status==='Pending').length, 
                            masterData.filter(a => a.status==='Approved').length, 
                            masterData.filter(a => a.status==='Rejected').length
                        ], 
                        backgroundColor: ['#f59e0b', '#10b981', '#ef4444'], 
                        borderWidth: 10, 
                        borderColor: '#fff',
                        hoverOffset: 15 
                    }] 
                }, 
                options: { 
                    maintainAspectRatio: false, 
                    cutout: '82%', 
                    plugins: { 
                        legend: { 
                            position: 'bottom', 
                            labels: { padding: 30, usePointStyle: true, font: { size: 12, weight: 800 } } 
                        } 
                    } 
                } 
            });
        }

        // INIT SYSTEM
        fetchData();
    </script>

    <!-- Bootstrap Bundle with Popper -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard - Aloha Security</title>
    
    <!-- Load External Assets -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

    <style>
        /* CSS RESET & CORE STYLES */
        * { box-sizing: border-box; margin: 0; padding: 0; }
        
        body {
            background-color: #f0f2f5 !important; /* Force light gray background */
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            color: #1c1e21;
            line-height: 1.5;
        }

        .dashboard-container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        /* HEADER SECTION */
        .dashboard-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: #002b5c;
            padding: 15px 25px;
            border-radius: 10px;
            color: white;
            margin-bottom: 25px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }

        .logo-area h1 { font-size: 22px; margin: 0; }
        .logo-area p { font-size: 12px; opacity: 0.8; }
        
        .header-actions { display: flex; align-items: center; gap: 15px; }
        .btn-back { color: white; text-decoration: none; font-size: 14px; }
        .btn-logout { 
            background: #e74c3c; color: white; border: none; 
            padding: 8px 15px; border-radius: 5px; cursor: pointer; font-weight: bold;
        }

        /* STATS BOXES */
        .summary-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: white;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
            border-top: 5px solid #002b5c;
        }

        .stat-number { font-size: 32px; font-weight: bold; display: block; }
        .stat-label { color: #65676b; font-size: 14px; text-transform: uppercase; }

        /* DATA TABLE SECTION */
        .content-card {
            background: white;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
            overflow: hidden;
        }

        .card-title {
            padding: 20px;
            border-bottom: 1px solid #eee;
            font-size: 18px;
            font-weight: bold;
        }

        .table-header, .applicant-row {
            display: grid;
            grid-template-columns: 2fr 1.5fr 2fr 1.2fr 1fr 100px;
            padding: 15px 20px;
            align-items: center;
            gap: 10px;
        }

        .table-header {
            background: #f8f9fa;
            font-weight: bold;
            font-size: 13px;
            color: #4b4f56;
            text-transform: uppercase;
        }

        .applicant-row { border-bottom: 1px solid #f0f2f5; font-size: 14px; }
        .applicant-row:hover { background: #f9fafb; }

        /* STATUS TAGS */
        .status-pill {
            padding: 4px 10px;
            border-radius: 20px;
            font-size: 11px;
            font-weight: bold;
            text-align: center;
            display: inline-block;
        }
        .pending { background: #fff3cd; color: #856404; }
        .approved { background: #d4edda; color: #155724; }
        .rejected { background: #f8d7da; color: #721c24; }
        .reviewed { background: #cce5ff; color: #004085; }

        /* ACTION DROPDOWN */
        .dropdown { position: relative; display: inline-block; }
        .dropbtn { background: #eee; border: none; padding: 5px 10px; border-radius: 4px; cursor: pointer; }
        .dropdown-content {
            display: none;
            position: absolute;
            right: 0;
            background: white;
            min-width: 150px;
            box-shadow: 0 8px 16px rgba(0,0,0,0.2);
            z-index: 10;
            border-radius: 5px;
        }
        .dropdown-content button, .dropdown-content a {
            width: 100%;
            padding: 10px;
            border: none;
            background: none;
            text-align: left;
            cursor: pointer;
            display: block;
            text-decoration: none;
            color: black;
            font-size: 13px;
        }
        .dropdown-content button:hover { background: #f1f1f1; }
        .dropdown:hover .dropdown-content { display: block; }
        .delete-btn { color: #d93025 !important; border-top: 1px solid #eee !important; }

        #offline-notice {
            position: fixed; top: 0; left: 0; width: 100%; background: #d93025;
            color: white; text-align: center; padding: 5px; display: none; z-index: 9999;
        }
    </style>
</head>
<body>

    <div id="offline-notice">You are currently offline. Data may not be up to date.</div>

    <div class="dashboard-container">
        <header class="dashboard-header">
            <div class="logo-area">
                <h1>Aloha Security Admin</h1>
                <p>Application Management System</p>
            </div>
            <div class="header-actions">
                <a href="index.html" class="btn-back"><i class="fas fa-arrow-left"></i> Main Site</a>
                <button id="logout-btn" class="btn-logout">Logout</button>
            </div>
        </header>

        <section class="summary-stats">
            <div class="stat-card">
                <span class="stat-number" id="total-count">0</span>
                <span class="stat-label">Total</span>
            </div>
            <div class="stat-card">
                <span class="stat-number" id="pending-count" style="color: #f39c12;">0</span>
                <span class="stat-label">Pending</span>
            </div>
            <div class="stat-card">
                <span class="stat-number" id="approved-count" style="color: #28a745;">0</span>
                <span class="stat-label">Approved</span>
            </div>
        </section>

        <div class="content-card">
            <div class="card-title">Recent Applications</div>
            <div class="table-header">
                <div>Applicant</div>
                <div>Position</div>
                <div>Contact</div>
                <div>Status</div>
                <div>Date</div>
                <div>Actions</div>
            </div>
            <div id="table-body">
                <!-- Rows load here -->
            </div>
        </div>
    </div>

    <script>
        // 1. SUPABASE SETUP
        const supabaseUrl = 'https://kkaelwhdcsgaodbhrxqt.supabase.co';
        const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImtrYWVsd2hkY3NnYW9kYmhyeHF0Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTYxOTA4NzksImV4cCI6MjA3MTc2Njg3OX0.wSFv1AZgZDXjGHiIwOHyWzqTDk0v6NbR4-2r90iF9ok';
        const _supabase = supabase.createClient(supabaseUrl, supabaseKey);

        // 2. SECURITY CHECK
        async function checkSession() {
            const { data } = await _supabase.auth.getSession();
            if (!data.session) {
                window.location.href = 'AdminLogin.html';
            } else {
                loadData();
            }
        }

        // 3. LOAD APPLICANTS
        async function loadData() {
            const { data: applicants, error } = await _supabase
                .from('applicants')
                .select('*')
                .order('created_at', { ascending: false });

            if (error) return console.error(error);

            // Update Stats
            document.getElementById('total-count').innerText = applicants.length;
            document.getElementById('pending-count').innerText = applicants.filter(a => a.status === 'Pending').length;
            document.getElementById('approved-count').innerText = applicants.filter(a => a.status === 'Approved').length;

            const container = document.getElementById('table-body');
            container.innerHTML = '';

            applicants.forEach(app => {
                const status = app.status || 'Pending';
                const row = document.createElement('div');
                row.className = 'applicant-row';
                row.innerHTML = `
                    <div style="font-weight:bold">${app.first_name} ${app.last_name}</div>
                    <div>${app.desired_position || 'N/A'}</div>
                    <div style="font-size:12px">${app.email}</div>
                    <div><span class="status-pill ${status.toLowerCase()}">${status}</span></div>
                    <div style="color:#666">${new Date(app.created_at).toLocaleDateString()}</div>
                    <div class="dropdown">
                        <button class="dropbtn">Manage <i class="fas fa-caret-down"></i></button>
                        <div class="dropdown-content">
                            <a href="view-applicant.html?id=${app.id}">View Details</a>
                            <button onclick="updateStatus('${app.id}', 'Approved')">Approve</button>
                            <button onclick="updateStatus('${app.id}', 'Rejected')">Reject</button>
                            <button onclick="deleteApp('${app.id}')" class="delete-btn">Delete</button>
                        </div>
                    </div>
                `;
                container.appendChild(row);
            });
        }

        // 4. ACTIONS
        async function updateStatus(id, newStatus) {
            await _supabase.from('applicants').update({ status: newStatus }).eq('id', id);
            loadData();
        }

        async function deleteApp(id) {
            if(confirm("Delete permanently?")) {
                await _supabase.from('applicants').delete().eq('id', id);
                loadData();
            }
        }

        document.getElementById('logout-btn').addEventListener('click', async () => {
            await _supabase.auth.signOut();
            window.location.href = 'AdminLogin.html';
        });

        // 5. RUN
        checkSession();

        // Offline check
        window.addEventListener('online', () => document.getElementById('offline-notice').style.display = 'none');
        window.addEventListener('offline', () => document.getElementById('offline-notice').style.display = 'block');
    </script>
</body>
</html>
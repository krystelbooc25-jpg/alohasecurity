<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Login - Aloha Security Agency</title>
    <link rel="stylesheet" href="Login.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body>
    <div class="login-container">
        <div class="login-panel branding-panel">
            <div class="branding-content">
                <!-- Siguraduhin na tama ang path ng logo -->
                <img src="Resources/logo.jpg" alt="Aloha Security Agency Logo" class="logo" style="width: 100px; border-radius: 50%;">
                <h1>Welcome, Administrator</h1>
                <p>Your command center for managing professional security services.</p>
                <a href="index.html" class="back-to-site-link"><i class="fas fa-arrow-left"></i> Back to Main Site</a>
            </div>
        </div>
        <div class="login-panel form-panel">
            <div class="form-content">
                <h2>Admin Login</h2>
                <p>Please enter your credentials to access the dashboard.</p>
                <form id="admin-login-form">
                    <div class="input-group">
                        <i class="fas fa-envelope"></i>
                        <input type="email" id="email" name="email" placeholder="Email Address" required>
                    </div>
                    <div class="input-group">
                        <i class="fas fa-lock"></i>
                        <input type="password" id="password" name="password" placeholder="Password" required>
                    </div>
                    <button type="submit" id="login-button" class="btn-login">Login Securely</button>
                </form>
                <p id="error-message" style="color: red; text-align: center; margin-top: 15px;"></p>
                <p id="cooldown-message" style="color: blue; text-align: center; margin-top: 15px;"></p>
            </div>
        </div>
    </div>

    <div id="offline-overlay" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.8); color:white; justify-content:center; align-items:center; z-index:9999;">
        <div style="text-align:center;">
            <h1>You are Offline</h1>
            <p>Please check your internet connection.</p>
        </div>
    </div>

    <script>
        // --- 1. INITIALIZE SUPABASE AND DOM ELEMENTS ---
        const supabaseUrl = 'https://kkaelwhdcsgaodbhrxqt.supabase.co';
        const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImtrYWVsd2hkY3NnYW9kYmhyeHF0Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTYxOTA4NzksImV4cCI6MjA3MTc2Njg3OX0.wSFv1AZgZDXjGHiIwOHyWzqTDk0v6NbR4-2r90iF9ok';
        const { createClient } = supabase;
        const supabaseClient = createClient(supabaseUrl, supabaseKey);

        const loginForm = document.getElementById('admin-login-form');
        const loginButton = document.getElementById('login-button');
        const errorMessage = document.getElementById('error-message');
        const cooldownMessage = document.getElementById('cooldown-message');
        const offlineOverlay = document.getElementById('offline-overlay');

        let loginAttempts = parseInt(localStorage.getItem('loginAttempts')) || 0;
        let cooldownUntil = parseInt(localStorage.getItem('cooldownUntil')) || 0;
        let cooldownTimer;

        // --- 2. COOLDOWN LOGIC ---
        function handleCooldown() {
            const now = Date.now();
            if (now < cooldownUntil) {
                loginForm.email.disabled = true;
                loginForm.password.disabled = true;
                loginButton.disabled = true;

                cooldownTimer = setInterval(() => {
                    const remaining = Math.ceil((cooldownUntil - Date.now()) / 1000);
                    if (remaining > 0) {
                        cooldownMessage.textContent = `Too many failed attempts. Please try again in ${remaining} seconds.`;
                    } else {
                        clearInterval(cooldownTimer);
                        cooldownMessage.textContent = '';
                        loginForm.email.disabled = false;
                        loginForm.password.disabled = false;
                        loginButton.disabled = false;
                    }
                }, 1000);
            }
        }

        // --- 3. LOGIN FORM SUBMISSION LOGIC ---
        loginForm.addEventListener('submit', async (event) => {
            event.preventDefault();
            errorMessage.textContent = '';

            const email = loginForm.email.value;
            const password = loginForm.password.value;

            try {
                const { data, error } = await supabaseClient.auth.signInWithPassword({ email, password });
                if (error) {
                    loginAttempts++;
                    localStorage.setItem('loginAttempts', loginAttempts);

                    let cooldownDuration = 0;
                    if (loginAttempts === 3) cooldownDuration = 30;
                    else if (loginAttempts === 4) cooldownDuration = 60;
                    else if (loginAttempts >= 5) cooldownDuration = 300;

                    if (cooldownDuration > 0) {
                        cooldownUntil = Date.now() + cooldownDuration * 1000;
                        localStorage.setItem('cooldownUntil', cooldownUntil);
                        handleCooldown();
                    }
                    errorMessage.textContent = error.message;
                } else {
                    // On success, reset attempts and redirect
                    localStorage.removeItem('loginAttempts');
                    localStorage.removeItem('cooldownUntil');
                    
                    // FIXED REDIRECTION: Dito tayo nagka-error. Dapat 'dashboard.html' 
                    // dahil iyon ang filename mo sa GitHub.
                    window.location.href = 'dashboard.html';
                }
            } catch (error) {
                errorMessage.textContent = 'An unexpected error occurred. Please try again.';
            }
        });

        // --- 4. OFFLINE/ONLINE STATUS CHECKER ---
        function updateOnlineStatus() {
            if (navigator.onLine) {
                offlineOverlay.style.display = 'none';
            } else {
                offlineOverlay.style.display = 'flex';
            }
        }
        window.addEventListener('online', updateOnlineStatus);
        window.addEventListener('offline', updateOnlineStatus);

        // --- 5. INITIAL CHECKS ON PAGE LOAD ---
        handleCooldown(); 
        updateOnlineStatus(); 
    </script>
</body>
</html>